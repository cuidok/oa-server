# Verification design document

## Login verification design

### Login verification container

The login verification container provides the function to store, query and delete the login verification.

The verification container uses the `login_verification_key` as the key, and the login verification code as the value.

### Generate login verification key

The system generates the login verification key to user for generating and querying the login verification code.

The design of login verification key is as follows:

1. The login verification key must be unique.

The generating steps of the login verification key are as follows:

1. Get the current time.
2. Generate a random number from 10000 to 99999.
3. Combine the current time and the random number to generate the login verification key.
4. Use the AES algorithm to encrypt the login verification key.
5. User base64 to encode the encrypted login verification key.
6. Return the login verification key.

The login verification key is valid for 5 minutes.

Pay attention to query the login verification code, you need to use AES algorithm to decrypt the login verification key
which is got from the user.

### Decrypt login verification key

When we use the login verification key to query the login verification code, we need to decrypt the login verification key.

The decrypting steps of the login verification key are as follows:

1. Use base64 to decode the login verification key.
2. Use the AES algorithm to decrypt the login verification key.

#### ConcurrentHashMap implementation

The login verification container can be implemented by using the `ConcurrentHashMap` class.

##### Store login verification

The function stores the login verification, the function follows the steps below:

1. Accept the login verification key and code.
2. Check input parameters.
3. Store the login verification.
4. Return the login verification code.

##### Delete login verification

The function deletes the login verification, the function follows the steps below:

1. Accept the login verification key.
2. Check input parameters.
3. Delete the login verification.

##### Query login verification

The function queries the login verification, the function follows the steps below:

1. Accept the login verification key.
2. Check input parameters.
3. Query the login verification.
4. Check the expired time of the login verification.
5. Return the login verification code.

If the login verification does not exist, the function will return `Optional.empty()`.

If the login verification is expired, the function will remove it and return `Optional.empty()`.

### Generate login verification code

The system generates the login verification code to user for verifying the login verification.

The generating steps of the login verification code are as follows:

1. Select 4 characters randomly from the `CHARACTERS`.
2. Return the verification code.

The `CHARACTERS` is composed of numbers and letters, but does not contain the confusing characters. it is defined as follows:

```java
private static final String CHARACTERS = "abcdefghijkmnpqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ23456789";
```

### Generate login verification picture

The system generates the login verification picture to user for verifying the login verification.

The generating steps of the login verification picture are as follows:

1. Accept the verification code.
2. Check whether the verification code is empty.
3. Draw the verification container.
4. Draw the verification code in the container.
5. Draw some colorful lines in the container.
6. Draw some noise points in the container.
7. Return the image.

The verification container size is 100x30, its background color is white.

The verification font size is 20, its color is black.

The verification font need to evenly distributed on the canvas. 

### Verify login verification picture

This function verifies the code input by user with the verification code generated by the system.

The function follows the steps below:

1. Accept the verification code input by user.
2. Check input parameters.
3. Query the login verification code from login verification container.
4. Check whether the verification code is correct.

When we check the verification code, we need to ignore the case of the characters.